<div class="container">

  <!-- Loading / Error -->
  <div *ngIf="loading" class="text-center my-3">
    Yükleniyor...
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    {{ errorMessage }}
    <button class="btn btn-sm btn-link" (click)="loadProducts()">Tekrar dene</button>
  </div>

  <h3>Sistemdeki Ürünlerin Listesi</h3>
  <!-- Admin control: form toggle -->
  <div class="mb-3">
    <button class="btn btn-primary"
            [disabled]="loading || !token.hasRole('ROLE_ADMIN')">
      {{ showCreateForm ? 'İptal' : 'Yeni Ürün Ekle' }}
    </button>
  </div>

  <!-- Create form (sadece admin ve liste yüklendiğinde göster) -->
  <div *ngIf="showCreateForm && token.hasRole('ROLE_ADMIN')" class="card mb-3 p-3">
    <form #productForm="ngForm"  novalidate>
      <div class="row g-2 align-items-center">
        <div class="col-md-5">
          <input
            class="form-control"
            name="name"
            placeholder="Ürün adı"
            required
            [(ngModel)]="newProduct.name"
            #nameCtrl="ngModel"
          />
          <div *ngIf="nameCtrl.invalid && (nameCtrl.dirty || nameCtrl.touched)" class="text-danger small">
            Ürün adı zorunlu.
          </div>
        </div>

        <div class="col-md-3">
          <input
            class="form-control"
            name="price"
            placeholder="Fiyat"
            required
            type="number"
            min="0"
            step="0.01"
            [(ngModel)]="newProduct.price"
            #priceCtrl="ngModel"
          />
          <div *ngIf="priceCtrl.invalid && (priceCtrl.dirty || priceCtrl.touched)" class="text-danger small">
            Geçerli bir fiyat girin.
          </div>
        </div>

        <div class="col-md-3">
          <select class="form-select" name="category" required [(ngModel)]="newProduct.category">
            <option *ngFor="let c of categories" [ngValue]="c">{{ c }}</option>
          </select>
        </div>

        <div class="col-auto">
          <button class="btn btn-success" type="submit" [disabled]="productForm.invalid">Kaydet</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Kategori bazlı ürün listesi -->
  <div *ngIf="!loading">
    <div *ngFor="let c of categories">
      <div *ngIf="groupedProducts[c] && groupedProducts[c].length" class="mb-4">
        <h5 class="mb-2">{{ c }}</h5>
        <div *ngFor="let p of groupedProducts[c]" class="mb-2">
          <div class="d-flex align-items-center justify-content-between border rounded p-2">
            <div>
              <strong>{{ p.name }}</strong>
              <div class="small">Fiyat: {{ p.price }}</div>
            </div>
            <div>
              <button class="btn btn-outline-primary btn-sm">Ürünü Düzenle</button>
              <button class="btn btn-outline-primary btn-sm">Ürünü Sil</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Eğer kategori yoksa -->
    <div *ngIf="!products.length" class="text-muted">
      Gösterilecek ürün yok.
    </div>
  </div>
</div>